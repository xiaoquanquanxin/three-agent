# 讨论记录 #4 - 技术方案最终确认

> 时间：2026-01-09
> 主题：部署方式、MVP 范围、数据库结构最终确认

---

## 一、关键技术决策

### 1. 部署方式 ✅

**确认：**
- ✅ **本地开发**（不用 LangSmith）
- ✅ **本地完全支持 interrupt 机制**
- ✅ **使用 LangGraph SDK**（最好有）

**理解：**
虽然官方示例提到了 LangSmith 部署，但代码中的 interrupt 机制在本地开发环境中同样可用。

---

### 2. MVP 功能范围 ✅

**确认：**
- ✅ 先实现**创建正方形**功能
- ✅ 能实现多少就实现多少

**MVP 第一阶段目标：**
```
用户输入："画一个正方形，边长5"
  ↓
后端 LangGraph 解析意图
  ↓
CreateAgent 创建数据（插入数据库）
  ↓
返回给前端：{"action": "create", "data": {...}}
  ↓
前端 Three.js 渲染正方形
  ↓
完成
```

**特点：**
- 不需要 interrupt（流程最简单）
- 可以快速验证整个架构
- 为后续功能打基础

---

### 3. 数据库表结构 ✅

**确认：**
- ✅ 使用提供的表结构
- ✅ JSON 存储几何数据

**最终表结构：**

#### 主表：shapes
```sql
CREATE TABLE shapes (
  id VARCHAR(36) PRIMARY KEY,
  type ENUM('square', 'circle', 'triangle') NOT NULL,
  geometry JSON NOT NULL,
  position_x FLOAT NOT NULL,
  position_y FLOAT NOT NULL,
  position_z FLOAT NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  INDEX idx_type (type),
  INDEX idx_created (created_at DESC)
);
```

#### 操作历史表：shape_operations
```sql
CREATE TABLE shape_operations (
  id INT AUTO_INCREMENT PRIMARY KEY,
  session_id VARCHAR(36) NOT NULL,
  shape_id VARCHAR(36),
  operation ENUM('create', 'update', 'delete') NOT NULL,
  before_state JSON,
  after_state JSON,
  operated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  INDEX idx_session (session_id, operated_at DESC)
);
```

---

## 二、MVP 第一阶段实现步骤

### 目标：实现"创建正方形"功能

#### 步骤 1：数据库准备
- 创建 shapes 表
- 创建 shape_operations 表
- 测试数据库连接

#### 步骤 2：后端 LangGraph 实现
- 定义 AgentState
- 实现 Supervisor Agent（意图识别）
- 实现 CreateAgent（创建正方形）
- 配置 Graph 和路由

#### 步骤 3：后端 API 实现
- POST /api/chat（接收用户输入）
- GET /api/shapes（获取场景对象）
- 数据库操作封装

#### 步骤 4：前端基础实现
- Three.js 场景初始化
- 对话框 UI
- 渲染正方形的函数

#### 步骤 5：联调测试
- 测试完整流程
- 验证数据库记录
- 验证前端渲染

---

## 三、技术栈确认

### 后端
- Node.js + TypeScript
- LangGraph（本地开发）
- LangGraph SDK（推荐使用）
- MySQL
- Express（或其他 Web 框架）

### 前端
- React + TypeScript
- Three.js
- LangGraph SDK Client

### 关键依赖
```json
{
  "dependencies": {
    "@langchain/langgraph": "latest",
    "@langchain/langgraph-sdk": "latest",
    "@langchain/openai": "latest",
    "three": "latest",
    "mysql2": "latest"
  }
}
```

---

## 四、关键共识总结

### 1. 本地开发 + interrupt 机制
- 不需要部署到 LangSmith
- 本地开发完全支持 interrupt
- 使用 LangGraph SDK

### 2. MVP 策略
- 先实现创建正方形（最简单）
- 能实现多少就实现多少
- 快速验证架构可行性

### 3. 数据库设计
- 使用 JSON 存储几何数据
- 单独的 operations 表支持 undo/redo
- 表结构已确定

### 4. "上一个正方形"方案
- MVP 阶段：基于创建时间（数据库查询）
- 优化阶段：升级到引用栈

---

## 五、下一步行动

### 立即可以开始的工作：
1. 创建数据库表
2. 搭建后端项目骨架
3. 搭建前端项目骨架
4. 实现 CreateAgent（创建正方形）

### 需要进一步讨论的：
- 前端 Three.js 的具体渲染细节
- LangGraph 本地开发的具体配置
- API 接口的详细设计

---

## 六、待确认问题

目前所有关键技术决策已确认 ✅

如果你同意以上方案，我们可以开始实现 MVP 了。
