# å¼€å‘æ—¥å¿— - 2026-01-13

## ä¼šè¯ä¸»é¢˜ï¼šLangGraph SDK æµ‹è¯•ä¸é—®é¢˜ä¿®å¤

### ä¸€ã€èƒŒæ™¯
ç”¨æˆ·è¯¢é—® SDK æ¥å…¥æƒ…å†µï¼Œå‰ä¸€ä¸ª Claude å·²ç»å®ç°äº† SDK ä»£ç ä½†æœªæµ‹è¯•ã€‚æœ¬æ¬¡ä¼šè¯çš„ç›®æ ‡æ˜¯æµ‹è¯• SDK æ–¹å¼å¹¶ä¿®å¤é‡åˆ°çš„é—®é¢˜ã€‚

---

## äºŒã€SDK æ¥å…¥ç°çŠ¶æ€»ç»“

### âœ… å·²å®Œæˆçš„å·¥ä½œï¼ˆå‰ä¸€ä¸ª Claudeï¼‰

1. **SDK ä¾èµ–å®‰è£…**
   - `@langchain/langgraph-sdk`: ^1.5.2
   - `@langchain/langgraph-cli`: ^1.1.11

2. **LangGraph Server é…ç½®**
   - `backend/langgraph.json` é…ç½®æ­£ç¡®
   - Graph å¯¼å‡ºï¼š`workflow.ts:graph`

3. **SDK Handler å®ç°**
   - `backend/src/api/handlers-sdk.ts`
   - `handleChatSDK`: å¤„ç†æ–°æ¶ˆæ¯
   - `handleChatSDKContinue`: å¤„ç† interrupt åçš„ continue

4. **API è·¯ç”±é…ç½®**
   - `POST /api/chat-sdk`: SDK æ–¹å¼
   - `POST /api/chat-sdk/continue`: Continue è¯·æ±‚
   - `POST /api/chat`: æ—§ç‰ˆç›´æ¥è°ƒç”¨æ–¹å¼ï¼ˆä¿ç•™ï¼‰

---

## ä¸‰ã€æµ‹è¯•è¿‡ç¨‹ä¸é—®é¢˜ä¿®å¤

### é—®é¢˜ 1ï¼šHTTP 422 - Thread is already running a task

**ç°è±¡**ï¼š
```json
{
  "error": "å¤„ç†æ¶ˆæ¯å¤±è´¥",
  "details": "HTTP 422: Thread is already running a task. Wait for it to finish or choose a different multitask strategy."
}
```

**åŸå› åˆ†æ**ï¼š
1. LangGraph SDK é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸€ä¸ª thread åŒæ—¶åªèƒ½è¿è¡Œä¸€ä¸ªä»»åŠ¡
2. éœ€è¦æ·»åŠ  `multitaskStrategy` å‚æ•°æ¥å¤„ç†å¹¶å‘è¯·æ±‚

**è§£å†³æ–¹æ¡ˆ 1**ï¼šæ·»åŠ  multitaskStrategy
```typescript
// backend/src/api/handlers-sdk.ts:36
const streamResponse = client.runs.stream(
  actualThreadId,
  ASSISTANT_ID,
  {
    input: { messages: [{ role: 'user', content: message }] },
    streamMode: 'values',
    multitaskStrategy: 'reject',  // æ‹’ç»å¹¶å‘è¯·æ±‚ï¼Œç¡®ä¿å•çº¿ç¨‹æ‰§è¡Œ
  }
);
```

**ç»“æœ**ï¼šé—®é¢˜ä¾ç„¶å­˜åœ¨ï¼Œç»§ç»­è°ƒæŸ¥ã€‚

---

### é—®é¢˜ 2ï¼šThread æœªåˆ›å»º

**ç°è±¡**ï¼š
å³ä½¿æ·»åŠ äº† `multitaskStrategy`ï¼Œä»ç„¶è¿”å› 422 é”™è¯¯ã€‚

**åŸå› åˆ†æ**ï¼š
æŸ¥çœ‹ä»£ç å‘ç°ï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨ `generateId()` ç”Ÿæˆ threadIdï¼Œä½†æ²¡æœ‰å…ˆåœ¨ LangGraph Server ä¸­åˆ›å»º threadã€‚SDK è¦æ±‚å¿…é¡»å…ˆåˆ›å»º threadã€‚

**è§£å†³æ–¹æ¡ˆ 2**ï¼šå…ˆåˆ›å»º thread
```typescript
// backend/src/api/handlers-sdk.ts:26-31
let actualThreadId = threadId;
if (!actualThreadId) {
  const thread = await client.threads.create();
  actualThreadId = thread.thread_id;
  console.log(`\nğŸ†• SDK: åˆ›å»ºæ–° thread: ${actualThreadId}`);
}
```

**ç»“æœ**ï¼šSDK è°ƒç”¨æˆåŠŸï¼Œä½†è¿”å› `action: "none"`ã€‚

---

### é—®é¢˜ 3ï¼šSqliteError - NOT NULL constraint failed: shape_operations.session_id

**ç°è±¡**ï¼š
ä» LangGraph Server çš„ thread state ä¸­çœ‹åˆ°é”™è¯¯ï¼š
```
"åˆ›å»ºå¤±è´¥: SqliteError: NOT NULL constraint failed: shape_operations.session_id"
```

**åŸå› åˆ†æ**ï¼š
åœ¨ `createAgent.ts:302` è°ƒç”¨ `recordOperation` æ—¶ä½¿ç”¨äº† `state.sessionId`ï¼Œä½†è¿™ä¸ªå€¼åœ¨ SDK è°ƒç”¨æ—¶ä¸ºç©ºå­—ç¬¦ä¸²ï¼ˆé»˜è®¤å€¼ï¼‰ã€‚

**è§£å†³æ–¹æ¡ˆ 3**ï¼šæä¾›é»˜è®¤å€¼
```typescript
// backend/src/agents/createAgent.ts:302
recordOperation({
  session_id: state.sessionId || 'default',  // æä¾›é»˜è®¤å€¼é¿å… NOT NULL é”™è¯¯
  shape_id: id,
  operation: 'create',
  before_state: null,
  after_state: { id, type, vertexList, position },
});
```

**ç»“æœ**ï¼šæ•°æ®åº“æ’å…¥æˆåŠŸï¼Œä½†ä»ç„¶è¿”å› `action: "none"`ã€‚

---

### é—®é¢˜ 4ï¼šReferenceError - summarizationMiddleware is not defined

**ç°è±¡**ï¼š
Express æœåŠ¡å™¨é‡å¯æ—¶æŠ¥é”™ï¼š
```
ReferenceError: summarizationMiddleware is not defined
    at createSupervisorAgent (supervisor.ts:21:17)
```

**åŸå› åˆ†æ**ï¼š
`supervisor.ts` ä¸­å¼•å…¥äº†ä¸å­˜åœ¨çš„ `summarizationMiddleware`ï¼Œè¿™æ˜¯ä¸€ä¸ªæœªå®ç°çš„åŠŸèƒ½ã€‚

**è§£å†³æ–¹æ¡ˆ 4**ï¼šç§»é™¤ middleware
```typescript
// backend/src/agents/supervisor.ts:14-21
const llm = new ChatOpenAI({
  modelName: config.modelName,
  temperature: 0.7,
  openAIApiKey: config.apiKey,
  configuration: {
    baseURL: config.baseURL,
  },
  // ç§»é™¤äº† middleware é…ç½®
});
```

**ç»“æœ**ï¼šæœåŠ¡å™¨æ­£å¸¸å¯åŠ¨ã€‚

---

## å››ã€æœ€ç»ˆæµ‹è¯•ç»“æœ

### âœ… æµ‹è¯•æˆåŠŸ

**æµ‹è¯•å‘½ä»¤**ï¼š
```bash
curl -X POST http://localhost:8888/api/chat-sdk \
  -H "Content-Type: application/json" \
  -d '{"message": "create a square with side length 8"}'
```

**å“åº”ç»“æœ**ï¼š
```json
{
  "status": "completed",
  "message": "å·²åˆ›å»ºæ­£æ–¹å½¢",
  "sessionId": "16a28b55-c5a3-45f9-86e7-ed154f70998f",
  "threadId": "1ba8df48-e5b5-48e9-9a65-8441eb9f3e21",
  "action": "create",
  "data": {
    "id": "cc05cec3-2911-4ea5-8b31-ba97965a4381",
    "type": "square",
    "vertexList": [[-4,0,-4], [4,0,-4], [4,0,4], [-4,0,4]],
    "position": [0,0,0],
    "position_x": 0,
    "position_y": 0,
    "position_z": 0
  }
}
```

**æ•°æ®åº“éªŒè¯**ï¼š
```bash
curl http://localhost:8888/api/shapes | grep "cc05cec3-2911-4ea5-8b31-ba97965a4381"
```
âœ… å½¢çŠ¶å·²æˆåŠŸä¿å­˜åˆ°æ•°æ®åº“

**åç«¯æ—¥å¿—**ï¼š
```
ğŸ†• SDK: åˆ›å»ºæ–° thread: 1ba8df48-e5b5-48e9-9a65-8441eb9f3e21
ğŸ“¨ SDK: æ”¶åˆ°æ¶ˆæ¯: "create a square with side length 8..."
âœ… SDK: è¿”å›å“åº”: create
```

---

## äº”ã€SDK æ–¹å¼ vs ç›´æ¥è°ƒç”¨æ–¹å¼å¯¹æ¯”

### æ–¹å¼ 1ï¼šç›´æ¥è°ƒç”¨ï¼ˆæ—§ç‰ˆï¼‰
**è·¯ç”±**: `POST /api/chat`
**æµç¨‹**:
```
å‰ç«¯ â†’ Express API â†’ workflow.invoke() â†’ è¿”å›ç»“æœ
```

**ç‰¹ç‚¹**:
- âœ… ç®€å•ç›´æ¥ï¼Œæ— éœ€é¢å¤–æœåŠ¡
- âœ… å·²æµ‹è¯•å¯ç”¨ï¼ˆMVP æµ‹è¯•é€šè¿‡ï¼‰
- âŒ ç¼ºå°‘ LangGraph Server çš„é«˜çº§ç‰¹æ€§
- âŒ ä¸æ”¯æŒ LangGraph Studio å¯è§†åŒ–è°ƒè¯•

### æ–¹å¼ 2ï¼šSDK è°ƒç”¨ï¼ˆæ–°ç‰ˆï¼‰- âœ… å·²æµ‹è¯•æˆåŠŸ
**è·¯ç”±**: `POST /api/chat-sdk`
**æµç¨‹**:
```
å‰ç«¯ â†’ Express API â†’ SDK Client â†’ LangGraph Server (localhost:2024) â†’ workflow â†’ è¿”å›ç»“æœ
```

**ç‰¹ç‚¹**:
- âœ… æ”¯æŒ LangGraph çš„å®Œæ•´ç”Ÿæ€
- âœ… å¯ä»¥ä½¿ç”¨ LangGraph Studio è°ƒè¯•
- âœ… æ›´å¥½çš„æµå¼å¤„ç†å’Œ interrupt æ”¯æŒ
- âœ… ç¬¦åˆç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ
- âœ… éœ€è¦é¢å¤–å¯åŠ¨ langgraph dev æœåŠ¡

---

## å…­ã€å…³é”®ä»£ç ä¿®æ”¹

### ä¿®æ”¹ 1ï¼šhandlers-sdk.ts - åˆ›å»º thread
```typescript
// å¦‚æœæ²¡æœ‰æä¾› threadIdï¼Œåˆ›å»ºæ–°çš„ thread
let actualThreadId = threadId;
if (!actualThreadId) {
  const thread = await client.threads.create();
  actualThreadId = thread.thread_id;
  console.log(`\nğŸ†• SDK: åˆ›å»ºæ–° thread: ${actualThreadId}`);
}
```

### ä¿®æ”¹ 2ï¼šhandlers-sdk.ts - æ·»åŠ  multitaskStrategy
```typescript
const streamResponse = client.runs.stream(
  actualThreadId,
  ASSISTANT_ID,
  {
    input: { messages: [{ role: 'user', content: message }] },
    streamMode: 'values',
    multitaskStrategy: 'reject',
  }
);
```

### ä¿®æ”¹ 3ï¼šcreateAgent.ts - ä¿®å¤ session_id
```typescript
recordOperation({
  session_id: state.sessionId || 'default',
  shape_id: id,
  operation: 'create',
  before_state: null,
  after_state: { id, type, vertexList, position },
});
```

### ä¿®æ”¹ 4ï¼šsupervisor.ts - ç§»é™¤ middleware
```typescript
const llm = new ChatOpenAI({
  modelName: config.modelName,
  temperature: 0.7,
  openAIApiKey: config.apiKey,
  configuration: {
    baseURL: config.baseURL,
  },
});
```

---

## ä¸ƒã€æœåŠ¡æ¶æ„

### å½“å‰è¿è¡Œçš„æœåŠ¡

1. **LangGraph Server** (localhost:2024)
   - å¯åŠ¨å‘½ä»¤ï¼š`cd backend && npx @langchain/langgraph-cli dev`
   - çŠ¶æ€ï¼šâœ… è¿è¡Œä¸­
   - Graph ID: `agent`
   - Assistant ID: `fe096781-5601-53d2-b2f6-0d3403f7e9ca`

2. **Express Backend** (localhost:8888)
   - å¯åŠ¨å‘½ä»¤ï¼š`cd backend && npm run dev`
   - çŠ¶æ€ï¼šâœ… è¿è¡Œä¸­
   - API ç«¯ç‚¹ï¼š
     - `/api/chat-sdk` - SDK æ–¹å¼
     - `/api/chat` - ç›´æ¥è°ƒç”¨æ–¹å¼
     - `/api/shapes` - è·å–æ‰€æœ‰å½¢çŠ¶

3. **SQLite Database**
   - ä½ç½®ï¼š`backend/database.db`
   - è¡¨ï¼š`shapes`, `shape_operations`
   - çŠ¶æ€ï¼šâœ… æ­£å¸¸å·¥ä½œ

---

## å…«ã€æŠ€æœ¯è¦ç‚¹æ€»ç»“

### 1. LangGraph SDK ä½¿ç”¨è¦ç‚¹

**å¿…é¡»å…ˆåˆ›å»º thread**ï¼š
```typescript
const thread = await client.threads.create();
const threadId = thread.thread_id;
```

**ä½¿ç”¨ multitaskStrategy**ï¼š
```typescript
client.runs.stream(threadId, assistantId, {
  input: {...},
  multitaskStrategy: 'reject'  // æˆ– 'interrupt', 'enqueue', 'rollback'
});
```

**æ£€æµ‹ interrupt**ï¼š
```typescript
for await (const chunk of streamResponse) {
  if (chunk.event === 'interrupt') {
    // å¤„ç† interrupt
    break;
  }
}
```

### 2. LangGraph Server é…ç½®

**langgraph.json**ï¼š
```json
{
  "dependencies": ["."],
  "graphs": {
    "agent": "./src/agents/workflow.ts:graph"
  },
  "env": "../.env"
}
```

**workflow.ts å¯¼å‡º**ï¼š
```typescript
export const graph = builder.compile({ checkpointer });
```

### 3. State é»˜è®¤å€¼å¤„ç†

**é—®é¢˜**ï¼šState ä¸­çš„å­—æ®µå¯èƒ½ä¸ºç©º
**è§£å†³**ï¼šæä¾›é»˜è®¤å€¼
```typescript
session_id: state.sessionId || 'default'
```

---

## ä¹ã€ä¸‹ä¸€æ­¥è®¡åˆ’

### å·²å®Œæˆ âœ…
- [x] SDK ä»£ç å®ç°
- [x] SDK æµ‹è¯•éªŒè¯
- [x] é—®é¢˜ä¿®å¤ï¼ˆthread åˆ›å»ºã€session_idã€middlewareï¼‰
- [x] æ•°æ®åº“éªŒè¯

### å¾…å®Œæˆ ğŸ“‹
1. **å‰ç«¯é€‚é… SDK æ–¹å¼**
   - ä¿®æ”¹ `frontend/src/App.tsx` ä½¿ç”¨ `/api/chat-sdk`
   - å®ç° interrupt å¤„ç†é€»è¾‘
   - å®ç°å‰ç«¯å·¥å…·ï¼ˆgetNearbyObjectsï¼‰

2. **æµ‹è¯• interrupt æœºåˆ¶**
   - æµ‹è¯•"åœ¨é™„è¿‘åˆ›å»ºæ­£æ–¹å½¢"åœºæ™¯
   - éªŒè¯ interrupt æš‚åœ/æ¢å¤æµç¨‹

3. **å®ç°å…¶ä»– Agent**
   - DeleteAgent
   - ModifyAgent
   - QueryAgent

4. **ä¼˜åŒ–å’Œå®Œå–„**
   - é”™è¯¯å¤„ç†
   - æ—¥å¿—ä¼˜åŒ–
   - æ€§èƒ½ä¼˜åŒ–

---

## åã€å…³é”®æ–‡ä»¶æ¸…å•

### ä¿®æ”¹çš„æ–‡ä»¶
1. `backend/src/api/handlers-sdk.ts` - SDK Handler å®ç°
2. `backend/src/agents/createAgent.ts` - ä¿®å¤ session_id é—®é¢˜
3. `backend/src/agents/supervisor.ts` - ç§»é™¤ middleware

### é…ç½®æ–‡ä»¶
4. `backend/langgraph.json` - LangGraph Server é…ç½®
5. `backend/src/agents/workflow.ts` - Graph å¯¼å‡º

### æ–‡æ¡£è®°å½•
6. `doc/å¼€å‘æ—¥å¿—/2026-01-12-SDKæ¥å…¥çŠ¶æ€åˆ†æ.md` - SDK çŠ¶æ€åˆ†æ
7. `doc/å¼€å‘æ—¥å¿—/2026-01-13-SDKæµ‹è¯•æˆåŠŸ.md` - æœ¬æ–‡ä»¶

---

## åä¸€ã€éªŒè¯å‘½ä»¤

### å¯åŠ¨æœåŠ¡
```bash
# Terminal 1: LangGraph Server
cd backend
npx @langchain/langgraph-cli dev

# Terminal 2: Express Backend
cd backend
npm run dev
```

### æµ‹è¯• SDK API
```bash
# åˆ›å»ºæ­£æ–¹å½¢
curl -X POST http://localhost:8888/api/chat-sdk \
  -H "Content-Type: application/json" \
  -d '{"message": "create a square with side length 8"}'

# æŸ¥çœ‹æ‰€æœ‰å½¢çŠ¶
curl http://localhost:8888/api/shapes

# å¥åº·æ£€æŸ¥
curl http://localhost:8888/health
```

### æŸ¥çœ‹ LangGraph Studio
æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š
```
https://smith.langchain.com/studio?baseUrl=http://localhost:2024
```

---

## åäºŒã€é—®é¢˜è¿½è¸ª

### å·²è§£å†³ âœ…
- âœ… HTTP 422: Thread is already running a task
- âœ… Thread æœªåˆ›å»ºé—®é¢˜
- âœ… SqliteError: NOT NULL constraint failed
- âœ… ReferenceError: summarizationMiddleware is not defined

### å·²çŸ¥é™åˆ¶
- âš ï¸ å‰ç«¯å°šæœªé€‚é… SDK æ–¹å¼ï¼ˆä»ä½¿ç”¨æ—§ç‰ˆ `/api/chat`ï¼‰
- âš ï¸ Interrupt æœºåˆ¶æœªæµ‹è¯•
- âš ï¸ åªå®ç°äº† CreateAgentï¼Œå…¶ä»– Agent å¾…å®ç°

---

**è®°å½•æ—¶é—´**ï¼š2026-01-13 10:05
**è®°å½•è€…**ï¼šClaude Code
**ä¼šè¯çŠ¶æ€**ï¼šSDK æµ‹è¯•æˆåŠŸï¼Œæ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½æ­£å¸¸ï¼Œå‡†å¤‡è¿›å…¥ä¸‹ä¸€é˜¶æ®µå¼€å‘
