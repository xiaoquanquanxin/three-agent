# 开发日志 - 2026-01-12

## 会话主题：MVP 测试与问题修复

### 一、背景
在之前的开发中已经完成了：
- ✅ Backend: LangGraph workflow, Supervisor Agent, CreateAgent
- ✅ Frontend: React + Three.js 3D 场景 + 对话界面
- ✅ Database: SQLite 数据库初始化

本次会话主要是启动服务进行 MVP 测试。

---

## 二、测试流程

### 1. 服务启动
- **后端**：`cd backend && npm run dev` → 运行在 http://localhost:8888
- **前端**：`cd frontend && npm run dev` → 运行在 http://localhost:5174

### 2. 首次测试：CreateAgent LLM 响应解析问题

**用户输入**：`画一个正方形，边长5`

**问题表现**：
- Supervisor 正确路由到 `create_agent`
- CreateAgent 的 LLM 返回了解释性文本而非纯 JSON：
  ```
  您提供的信息中没有具体的用户创建请求内容...
  ```
- 导致 JSON 解析失败

**根本原因**：
CreateAgent 的 systemPrompt 不够明确，LLM（Qwen）倾向于返回解释而非纯 JSON。

**解决方案**：
修改 `backend/src/agents/createAgent.ts` 的 systemPrompt：
```typescript
const systemPrompt = `你是一个专门处理创建几何对象的智能体。
重要：你必须只返回 JSON 格式，不要有任何其他文字！

示例：
输入："画一个正方形，边长5"
输出：{"type": "square", "params": {"sideLength": 5}, "position": {"x": 0, "y": 0, "z": 0}, "needsNearbyObjects": false}

记住：只返回 JSON，不要有任何解释！`;
```

**关键改进点**：
1. 添加明确指令："只返回 JSON 格式，不要有任何其他文字！"
2. 提供具体示例，展示输入→输出格式
3. 结尾再次强调："只返回 JSON，不要有任何解释！"

---

### 3. 测试结果

**后端日志**：
```
📨 收到消息: "画一个正方形，边长5"
🎯 Supervisor Agent: 分析用户意图...
➡️  下一个 Agent: create_agent
🎯 用户意图: create

🎨 CreateAgent: 处理创建对象请求...
📝 解析用户请求...
✅ 解析结果: {
  type: 'square',
  params: { sideLength: 5 },
  position: { x: 0, y: 0, z: 0 },
  needsNearbyObjects: false
}
🔨 执行创建操作...
✅ 创建成功: square (ID: 51945244-086e-479c-8c44-eeb41fd0dba3)

🎯 Supervisor Agent: 分析用户意图...
➡️  下一个 Agent: __end__
✅ Workflow 执行完成
```

**API 验证**：
```bash
$ curl --noproxy localhost http://localhost:8888/api/shapes
{
  "shapes": [{
    "id": "51945244-086e-479c-8c44-eeb41fd0dba3",
    "type": "square",
    "vertexList": [[-2.5,0,-2.5],[2.5,0,-2.5],[2.5,0,2.5],[-2.5,0,2.5]],
    "position_x": 0,
    "position_y": 0,
    "position_z": 0,
    "created_at": "2026-01-12 05:30:41"
  }]
}
```

**前端表现**：
- ✅ 3D 场景正常渲染
- ✅ 绿色正方形（#00ff88）显示在原点
- ✅ 可以用鼠标旋转、缩放视角
- ✅ 数据库中保存了形状数据

---

## 三、优化改进

### 问题 1：React.StrictMode 导致重复请求

**现象**：
用户刷新页面后，Network 显示发送了两次 `/api/shapes` 请求。

**原因**：
`frontend/src/main.tsx` 中使用了 `<React.StrictMode>`，在 React 18 开发模式下会故意挂载组件两次，导致 `useEffect` 执行两次。

**解决方案**：
移除 StrictMode（生产环境不受影响）：
```typescript
// 修改前
ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>,
)

// 修改后
ReactDOM.createRoot(document.getElementById('root')!).render(
  <App />
)
```

**结果**：
刷新页面只发送一次请求，符合预期。

---

### 问题 2：网格颜色不明显

**现象**：
黑色背景 + 暗色网格线，视觉效果不清晰。

**解决方案**：
修改 `frontend/src/components/ThreeScene.tsx` 中的网格颜色：
```typescript
// 修改前
const gridHelper = new THREE.GridHelper(50, 50, 0x444444, 0x222222)

// 修改后（更亮的灰色）
const gridHelper = new THREE.GridHelper(50, 50, 0xaaaaaa, 0x555555)
```

---

## 四、技术要点总结

### 1. LLM Prompt 工程
- **问题**：LLM 不按预期返回纯 JSON
- **经验**：
  - 明确声明期望的输出格式
  - 提供具体示例（输入→输出）
  - 多次强调关键约束
  - 对于 Qwen 等模型，需要特别强调"不要解释"

### 2. React 开发模式特性
- React 18 StrictMode 会故意执行副作用两次
- 用于帮助发现不纯的副作用
- 仅在开发模式，生产环境不受影响
- 可根据需要移除（权衡利弊）

### 3. Three.js 场景配置
- 网格颜色需要与背景色形成对比
- 黑色背景（0x1a1a1a）适合搭配亮灰色网格（0xaaaaaa/0x555555）
- 坐标轴辅助（AxesHelper）帮助调试

---

## 五、当前状态

### ✅ 已完成
- [x] Phase 1-4: 项目结构、后端、前端、数据库
- [x] MVP 测试：基础创建功能（正方形）
- [x] 修复 CreateAgent LLM 响应解析问题
- [x] 优化：移除 StrictMode 重复请求
- [x] 优化：提升网格可见度

### 📋 待测试
- [ ] 圆形创建（`创建一个圆形，半径10`）
- [ ] 三角形创建（`画一个三角形，大小8`）
- [ ] 多个形状并存

### 🚀 下一阶段计划
- **Phase 5**: 实现前端工具（getNearbyObjects）和 interrupt 机制
- **Phase 6**: 实现 DeleteAgent 和 ModifyAgent

---

## 六、关键文件变更

### 修改的文件
1. `backend/src/agents/createAgent.ts`
   - 重写 systemPrompt，强制 JSON 输出
   - 行号：24-59

2. `frontend/src/main.tsx`
   - 移除 React.StrictMode
   - 行号：5-7

3. `frontend/src/components/ThreeScene.tsx`
   - 调整网格颜色参数
   - 行号：51

### 验证命令
```bash
# 启动后端
cd backend && npm run dev

# 启动前端
cd frontend && npm run dev

# 测试 API
curl --noproxy localhost http://localhost:8888/api/shapes

# 查看数据库
# 使用 Navicat Premium Lite 打开 backend/database.db
```

---

## 七、数据库状态

**shapes 表**：
- 1 条记录（正方形）
- ID: 51945244-086e-479c-8c44-eeb41fd0dba3
- Type: square
- Vertex List: [[-2.5,0,-2.5],[2.5,0,-2.5],[2.5,0,2.5],[-2.5,0,2.5]]
- Position: (0, 0, 0)

**shape_operations 表**：
- 1 条记录（create 操作）

---

## 八、下次开发方向

### 选项 1：继续测试基础功能
- 测试圆形、三角形创建
- 验证不同参数、位置的形状

### 选项 2：实现 interrupt 机制
- 前端实现 getNearbyObjects 工具
- 测试"在附近画一个正方形"场景
- 验证 interrupt 暂停/恢复流程

### 选项 3：实现其他 Agent
- DeleteAgent：处理删除操作
- ModifyAgent：处理修改操作
- QueryAgent：增强查询能力

---

**记录时间**：2026-01-12
**记录者**：Claude Code
**会话状态**：MVP 测试成功，基础功能正常，准备进入下一阶段
